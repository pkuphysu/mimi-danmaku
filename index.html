<!doctype html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="user-scalable=no"/>
<title>Mimi Danmaku</title>
<script src="cdn/jquery-3.3.1.min.js"></script>
<script>if (typeof module === "object") {window.jQuery = window.$ = module.exports;};</script>
<style>
body {
	background-attachment: fixed;
	text-align: center;
	font-family: Verdana, "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
	min-width: 960px;
}
span {
	color: #FFFFFF;
}
</style>
</head>
<body>
	<div style="position: fixed; bottom: 20px; left: 20px; z-index: 100; opacity: 0.9;">
		<img src="images/galaxymimi.svg" style="width: 200px; border-radius: 20px;"/>
		<br/>
		<span>Mimi弹幕</span>
		<br/>
		<span id="channel"></span>
	</div>
<script>
/*
const {dialog} = require("electron").remote;
function message(msg) {
	dialog.showMessageBox({message : msg});
}*/
const ipcRender = require("electron").ipcRenderer;

ipcRender.on("background", function(event, message) { // 监听父页面定义的端口
	if (message) canvas.style.cssText = "position: fixed; top: 0; left: 0; background-size: cover; z-index: -1; background-image: url(" + Bg + ");";
	else canvas.style.cssText = "position: fixed; top: 0; left: 0; background-size: cover; z-index: -1;";
});

ipcRender.on("setchannel", function(event, message) {
	document.getElementById("channel").innerHTML = "频道：" + message;
	document.getElementsByTagName("img")[0].src = "https://zsq.im/qrcode?margin=3&text=https://zsq.im/danmaku/?channel=" + message;
	//https://api.qrserver.com/v1/create-qr-code/?data=  http://qr.liantu.com/api.php?text=
});

ipcRender.on("danmaku", function(event, message) {
	var msg = JSON.parse(message);
	var messageArray = msg.content.split("|");
	output.push(createDanmaku(messageArray[0], messageArray[1], messageArray[2]));
});

ipcRender.on("remove", function(event, message) {
	var msg = JSON.parse(message);
	var messageArray = msg.content.split("|");
	for (var i in output) {
		output[i].x -= output[i].speed;
		if (output[i].text == messageArray[0]) {
			output.splice(i, 1); //会删除所有相同弹幕
		}
	}
});

var output = new Array();

var canvas = document.createElement("canvas");
var context = canvas.getContext("2d");
document.getElementsByTagName("body")[0].appendChild(canvas);

var availableBg = new Array("sky.jpg", "bg1.jpg", "bg2.jpg");
var Bg = "images/" + availableBg[Math.floor(Math.random() * availableBg.length)];

var W = window.innerWidth;
var H = window.innerHeight;
canvas.width = W;
canvas.height = H;
var fontSize = H / 10;

var availableColor = new Array("orange", "red", "blue", "purple", "green", "white");

window.onresize = function() {
	console.warn("WTF?");
  	W = window.innerWidth;
  	H = window.innerHeight;
  	canvas.width = W;
  	canvas.height = H;
  	fontSize = H / 10;
}

function createDanmaku(text, size, color) {
	var danmaku = new Object();
	danmaku.speed = (W / 500) * (Math.random() * 0.5 + 0.75);
	danmaku.x = W;
	danmaku.y = Math.random() * H * 4 / 5 + fontSize;
	danmaku.text = text;
	danmaku.size = fontSize * size;
	var reg = new RegExp("^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$");
	if (reg.test(color)) danmaku.color = color;
	else danmaku.color = availableColor[Math.floor(Math.random() * availableColor.length)];
	return danmaku;
}

function draw(obj) {
	context.font = "700 " + obj.size + "px Microsoft YaHei";
	context.fillStyle = obj.color;
	context.fillText(obj.text, obj.x, obj.y);
}

function drawAll() {
	context.clearRect(0, 0, W, H);
	for (var i in output) {
		draw(output[i]);
		output[i].x -= output[i].speed;
		if (output[i].x < -context.measureText(output[i].text).width) {
			output.splice(i, 1);
			console.log(i);
		}
	}
}

setInterval(drawAll, 20);

</script>
</body>
</html>
